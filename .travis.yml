language: python
python: 3.7
sudo: true
dist: bionic
branches:
  only:
  - master

env:
  global:
    - GOOGLE_DOCKER_IMAGE=gcr.io/athenian-1/api
    - IMAGE_BRANCH_COMMIT=${GOOGLE_DOCKER_IMAGE}:${TRAVIS_COMMIT:0:7}

cache:
  directories:
    - "$HOME/.cache/pip"
    - "$HOME/google-cloud-sdk/"
    - "$HOME/docker"

before_cache:
  - chown -R travis:travis $HOME/.cache/pip
  - docker save -o $HOME/docker/images.tar ${GOOGLE_DOCKER_IMAGE}:latest

stages:
  - main
  - bump-version

matrix:
  fast_finish: true
  include:
    - if: commit_message !~ /Bump version/
      stage: main
      name: Auto generated js client tests
      script:
        - docker run --rm -v `pwd`:/local openapitools/openapi-generator-cli generate --input-spec=/local/spec/openapi.yaml --generator-name=javascript --output=/local/js-client
        - npm --prefix js-client install
        - npm --prefix js-client test

notifications:
  email: false